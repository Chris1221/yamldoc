version: 2.1

branches:
  only:
    - master

jobs:
  build-and-test:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install Pixi
          command: |
            curl -fsSL https://pixi.sh/install.sh | bash
            echo 'export PATH=$HOME/.pixi/bin:$PATH' >> $BASH_ENV
      - run:
          name: Install dependencies
          command: pixi install
      - run:
          name: Test
          command: pixi run test
      - run:
          name: Install codecov
          command: pixi run pip install codecov
      - run:
          name: Run coverage test
          command: pixi run test-coverage
      - run:
          name: Upload coverage
          command: pixi run python -m codecov

workflows:
  main:
    jobs:
      - build-and-test
